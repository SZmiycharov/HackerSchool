<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>JSONCreator</title>
    <link rel="stylesheet" style="text/css" href="deps/opt/bootstrap.css" />
    <style>
      .container {
          overflow:hidden;
          max-width: 100%;
          min-height: 15%;
          min-width: 70%;
          background-color: #7DA5A6;
          border: 1px solid #718D8E;
          border-radius: 4px;
          display: inline-block;
          padding: 1%;
      }

      .container .container {
          overflow:hidden;
          min-height: 10%;
          min-width: 70%;
          background-color: #97a8a9;
          border: 3px solid #BED5D6;
          display: block;
          margin-top: 5px;
          margin-bottom: 2%;
      }
      .currentContainerHover {
        background-color: #616a6b;
      }

      .item {
          overflow:hidden;
          background-color: #6065C9;
          border: 2px solid #353871;
          margin-bottom: 1%;
          margin-top: 5px;
          border-radius: 2px;
          padding: -1px 50px;
          min-height: 3%;
      }
      .currentItemHover {
        background-color: #4249d6;
      }
      .svz-label-item {
        font-weight: bold;
        font-size: 20px;
        display: inline;
        position: absolute;
        margin-left: 10px;
        margin-top: 5px;
        margin-bottom: 10px;
      }
      .svz-label-container {
        font-weight: bold;
        font-size: 20px;
        display: inline;
        position: absolute;
        margin-left: 10px;
        margin-top: 5px;
        margin-bottom: 10px;
      }
      #svz-json-preview{
        float: right; 
        width: 45%; 
        margin-right: 3%; 
        margin-top: 2%;
        position: fixed;
        top: 2%;
        right: 0;
      }

    </style>

  </head>

  <body>
    <!-- hidden form for cloning -->
    <div class="tab-content" id="tab-content9999999" hidden>
      <div id="svz-schema-form-tabs-container9999999" class="tab-pane active">
          <div id="svz-left-container9999999" style="float:left; width:45%; margin-left: 50px; margin-top: 20px;"> 
            <ul class="nav nav-tabs" id="svz-schema-form-tabs9999999">
              <li class="active"><a data-target="#svz-schema-tab" data-toggle="tab">Schema</a></li>
              <li><a data-target="#svz-form-tab" data-toggle="tab">Form</a></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane active" id="svz-schema-tab9999999">
                <h2>For schema:</h2>
                <form id="svz-schema-form9999999" action="javascript:void(0);" onsubmit="HandleFormSubmit(this, this.id);">
                    <label class="svzRequiredLabel">Type</label>
                    <div>
                      <select class="svz-selected-type" id="svz-selected-type9999999" name="type9999999" required multiple>
                        <option s="object" value="object">object</option>
                        <option label="array" value="array">array</option>
                        <option label="number" value="number">number</option> 
                        <option label="integer" value="integer">integer</option>
                        <option label="string" value="string">string</option>  
                        <option label="boolean" value="boolean">boolean</option> 
                        <option label="null" value="null">null</option>
                      </select>
                    </div>
                    <label class="svzRequiredLabel">Key<font class="svzKeyWarning" id="svz-key-warning9999999" color="red" hidden> (key already exists)</font></label>
                    <div><input id="svz-key9999999" class="svz-key" placeholder="Key (Unique identifier)" type="text" name="key9999999" required></div>
                    <label>Title</label>
                    <div><input placeholder="Title" type="text" name="title9999999"></div>
                    <!-- <label>Ordering</label>
                    <div><input placeholder="Ordering" type="number" name="ordering9999999"></div> -->
                    <label>Description</label>
                    <div><input class="longtext" id="svz-description9999999" placeholder="Description" type="text" name="description9999999"></div>
                    <div><label style="display: flex;"><input id="svz-required" type="checkbox" name="required9999999">Required (check for true)</label></div>
                    <label id="svz-label-for-enum9999999">Enum</label>
                    <ul id="svz-enum9999999" name="enum9999999" class="svz-enum"></ul>
                    <input class="btn btn-primary" id="svz-schema-form-submit9999999" type="submit" value="Update">
                </form>
              </div>
              <div class="tab-pane" id="svz-form-tab9999999">
                <h2 id="svz-for-form9999999">For form:</h2>
                <form id="svz-for-form-form9999999"></form>
              </div>
            </div> 
          </div>   
      </div>
    </div>


    <div style="float:left; width:45%; margin-left: 50px; margin-top: 40px;">
      <div>
        <button id="svz-sorting-btn" type="button" class="btn btn-primary">Allow sorting</button>
        <button id="svz-show-json-preview" type="button" class="btn btn-success" onclick="ShowJSONPreview();">Show JSON</button>
      </div>
      <div></div>
      <div class="container" id="svz-container1">
        <button id="svz-add-item1" class="btn btn-secondary svz-add-item" type="button">+</button>
      </div>
    </div>

    <div id="svz-json-preview">
        <h3>Preview appears here:</h3>
        <p id="svz-json-text-header">When you choose options json will appear here! :)</p>
        <pre id="svz-json-text">{this is json surely :D}</pre>
    </div>


    <script src="deps/jquery.min.js"></script>
    <script type="text/javascript" src="deps/bootstrap.min.js"></script>
    <script type="text/javascript" src="deps/bootstrap-multiselect.js"></script>
    <link rel="stylesheet" href="deps/bootstrap-multiselect.css" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/flick/jquery-ui.css">
    <link href="deps/jquery.tagit.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="deps/underscore.js"></script>
    <script type="text/javascript" src="deps/opt/jsv.js"></script>
    <script type="text/javascript" src="lib/jsonform.js"></script>
    <script src="deps/jquery.ba-throttle-debounce.js"></script>
    <script src="deps/lodash.min.js"></script>
    <script type="text/javascript" src="deps/jquery-ui.min.js"></script>
    <script src="deps/tag-it.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">

    (function svzMainFunction ($) {
      'use strict';
        $( document ).ready(function() {
          var TIMEOUT_DEBOUNCE = 500;
          
          var currentSchemaFormID = 1;
          var currentContainerID = 5;
          var currentItemID = 5;
          var allKeys = [];
          var lastProperties;

          jQuery.fn.extend({
            prependClass: function(newClasses) {
                return this.each(function() {
                    var currentClasses = $(this).prop("class");
                    $(this).removeClass(currentClasses).addClass(newClasses + " " + currentClasses);
                });
            }
          });

          var getkeys = function(obj, prefix){
              var keys = Object.keys(obj);
              prefix = prefix ? prefix + '.' : '';
              return keys.reduce(function(result, key){
                  if(typeof obj[key] === 'object'){
                      result = result.concat(getkeys(obj[key], prefix + key));
                  }else{
                      result.push(prefix + key);
                  }
                  return result;
              }, []);
          };

          var draggedObject;
          window.InitializeSortable = function() {
            $('.container').sortable({
                delay: 150,
                items: '.item, .container-wrapper',
                cancel: ':button, input',
                axis: 'y',
                cursor: 'move',
                tolerance: 'pointer',
                connectWith: '.container',
                start: function(){
                  console.log('start position: ' + $(this).attr('id'));

                  var currentKeyContainer = $(this).find('.svz-label-container').html();
                  var currentKeyItem = $(this).find('.svz-label-item').html(); 

                  if ($(this).attr('id') !== 'svz-container1'){
                    var allPaths = getkeys(properties);
                    for (var i = 0; i < allPaths.length; i++){
                      if (_.include(allPaths[i], currentKeyItem)){
                        var currentPath = allPaths[i].split('.' + currentKeyItem)[0].split('.type')[0];
                      }
                    }

                    draggedObject = Object.byString(properties, currentPath)[currentKeyItem];

                    delete Object.byString(properties, currentPath)[currentKeyItem];
                  } else{
                    draggedObject = properties[currentKeyItem];
                    delete properties[currentKeyItem];
                  }
                  
                },
                change: $.debounce(1200, function(event, ui) {
                  console.log('change position: ' + $(this).attr('id'));
                  var currentKeyContainer = $(this).find('.svz-label-container').html();
                  var currentKeyItem = $(this).find('.svz-label-item').html();

                  if ($(this).attr('id') !== 'svz-container1'){
                    
                    // var path = search('schema', properties, lastProperties);
                    // console.log(path);
                    // var words = [];
                    // try{
                    //   path.replace(/\['(.+?)'\]/g, function($0, $1) { words.push($1) })
                    // } catch(e){
                    //   return;
                    // }

                    console.log(currentKeyContainer);
                    var allPaths = getkeys(properties);
                    for (var i = 0; i < allPaths.length; i++){
                      if (_.include(allPaths[i], currentKeyContainer)){
                        var currentPath = allPaths[i].split('.' + currentKeyContainer)[0].split('.type')[0];
                      }
                    }
                    console.log(currentPath);

                    Object.byString(properties, currentPath)['properties'][currentKeyItem] = draggedObject;
                  } else{
                    properties[currentKeyItem] = draggedObject;
                  }
                  

                  

                }),

              });
          }

          window.InitializeMultiselectAndTagit = function(currentID) {
            $('#svz-selected-type' + currentID).multiselect({
              buttonWidth: '206px',
              nonSelectedText: 'Choose type',
              numberDisplayed: 3
            });
            $('#svz-enum' + currentID).tagit({
                allowSpaces: true,
                placeholderText: 'Enum'
            });
          }
     
          $(document).on('click', '.container, .item, .svz-label-item, .svz-label-container', function(e){
            if (e.target != this || $(this).attr('id') === 'svz-container1') return;
            e.stopPropagation();
            var currentID = $(this).attr('id').replace( /^\D+/g, '')

            if (_.include($(this).attr('id'), 'label')){
              if ($(this).attr('id') != 'svz-container1'){
                $(this).next().toggle();
              }
            } else{
              $('#' + $(this).find('.tab-content').attr('id')).toggle();
              //$(this).find('.tab-content').toggle();
            }

            
          });

          $(document).on('mouseover', '.container', function(e){
            e.stopPropagation();
            if ($(this).attr('id') != 'svz-container1'){
              $(this).css('background-color', '#616a6b');
            }
          });
          $(document).on('mouseout', '.container', function(){
            if ($(this).attr('id') != 'svz-container1'){
              $(this).css('background-color', '#97a8a9');
            }
          });

          $(document).on('mouseover', '.item', function(e){
            e.stopPropagation();
            $(this).prependClass('currentItemHover');
          });
          $(document).on('mouseout', '.item', function(){
            $(this).removeClass('currentItemHover');
          });

          $(document).on('click', '#svz-sorting-btn', function(){
            if($(this).text() === 'Allow sorting'){
              InitializeSortable();
              $('.container').sortable('enable');

              $(this).text('Disallow sorting');
              $(this).attr('class', 'btn btn-danger');
            } else{
              $(this).text('Allow sorting');

              $(this).attr('class', 'btn btn-primary');
              $('.container').sortable('disable');
            }
          });

          window.AppendObjectArrayForm = function(currentID) {
            //console.log('in AppendObjectArrayForm');
            currentContainerID += 1;
            currentItemID += 1;

            var currentLabel = $('#svz-label-item' + currentID).html();
            var $submittedFormDiv = $('#tab-content' + currentID);
            $submittedFormDiv.find('.multiselect').remove();
            $submittedFormDiv.find('.ui-widget-content:last').remove();

            $('#svz-item-container' + currentID).replaceWith('<div class="container-wrapper" id="svz-cont-wrapper' + currentContainerID + '"><div class="container" id="svz-container' + currentContainerID + '"><div class="btn-group" role="group"><button id="svz-add-item' + currentContainerID + '" class="btn btn-secondary svz-add-item" type="button">+</button><button id="svz-remove-container' + currentContainerID + '" class="btn btn-secondary svz-remove-container" type="button" >-</button></div><label class="svz-label-container" id="svz-label-container' + currentContainerID + '">' + currentLabel + '</label></div></div></div>');
            
            $submittedFormDiv.find('[id]').each(function() { 
              var newID = $(this).attr('id').replace(/\d+$/, function(str) { return currentContainerID; });
              $(this).attr('id', newID);
            });
            $submittedFormDiv.find('[name]').each(function() { 
              var newID = $(this).attr('name').replace(/\d+$/, function(str) { return currentContainerID; });
              $(this).attr('name', newID);
            });

            $('#svz-container' + currentContainerID).append($submittedFormDiv.hide());

            $('#svz-container' + currentContainerID).append('<div class="item"  id="svz-item-container' + currentItemID + '"><div class="btn-group" role="group"><button  id="svz-add-container' + currentItemID +'" class="btn btn-secondary svz-add-container" type="button" style="display: none;">+</button> <button id="svz-remove-item' + currentItemID + '" class="btn btn-secondary svz-remove-item" type="button">-</button></div><label class="svz-label-item" id="svz-label-item' + currentItemID + '">New schema</label></div></div>');

            if ($('#svz-sorting-btn').text() === 'Disallow sorting'){
              InitializeSortable();
            }

            var $clonedDiv = $('#tab-content9999999').clone();
            $clonedDiv.find('.multiselect').remove();
            $clonedDiv.find('.ui-widget-content:last').remove();
            $clonedDiv.find('[id]').each(function() { 
              var newID = $(this).attr('id').replace(/\d+$/, function(str) { return currentItemID; });
              $(this).attr('id', newID);
            });
            $clonedDiv.find('[name]').each(function() { 
              var newID = $(this).attr('name').replace(/\d+$/, function(str) { return currentItemID; });
              $(this).attr('name', newID);
            });
            var idWithoutNumber = $clonedDiv.attr('id').replace(/[0-9]/g, '');
            $clonedDiv.attr('id', idWithoutNumber + currentItemID)

            $('#svz-item-container' + currentItemID).append($clonedDiv);

            if ($('#svz-sorting-btn').text() === 'Disallow sorting'){
              InitializeSortable();
            }

            InitializeMultiselectAndTagit(currentItemID);
            InitializeMultiselectAndTagit(currentContainerID);
          }

          $(document).on('click', '.svz-add-item', function(e){
            e.stopPropagation();

            currentItemID += 1;
            var currentID = $(this).attr('id').replace( /^\D+/g, '');

            var $clonedDiv = $('#tab-content9999999').clone();
            $clonedDiv.find('.multiselect').remove();
            $clonedDiv.find('.ui-widget-content:last').remove();
            $clonedDiv.find('[id]').each(function() { 
              var newID = $(this).attr('id').replace(/\d+$/, function(str) { return currentItemID; });
              $(this).attr('id', newID);
            });
            $clonedDiv.find('[name]').each(function() { 
              var newID = $(this).attr('name').replace(/\d+$/, function(str) { return currentItemID; });
              $(this).attr('name', newID);
            });
            var idWithoutNumber = $clonedDiv.attr('id').replace(/[0-9]/g, '');
            $clonedDiv.attr('id', idWithoutNumber + currentItemID);

            if (!$(this).parent().parent().find('.container').html()){
              $('#svz-container' + currentID).append('<div class="item"  id="svz-item-container' + currentItemID + '"><div class="btn-group" role="group"><button id="svz-remove-item' + currentItemID + '" class="btn btn-secondary svz-remove-item" type="button">-</button></div><label class="svz-label-item" id="svz-label-item' + currentItemID + '">New schema</label></div>');
            } else {
              $('<div class="item"  id="svz-item-container' + currentItemID + '"><div class="btn-group" role="group"><button id="svz-remove-item' + currentItemID + '" class="btn btn-secondary svz-remove-item" type="button">-</button></div><label class="svz-label-item" id="svz-label-item' + currentItemID + '">New schema</label></div>').insertBefore('#svz-add-item' + currentID);
            }
            $('#svz-item-container' + currentItemID).append($clonedDiv);

            if ($('#svz-sorting-btn').text() === 'Disallow sorting'){
              InitializeSortable();
            }
            InitializeMultiselectAndTagit(currentItemID);
          });

          $(document).on('click', '.svz-remove-item', function(){
            delete properties[$(this).parent().parent().find('.svz-label-item').html()];
            allKeys.splice(_.indexOf(allKeys, $(this).parent().parent().find('.svz-label-item').html()), 1);
            $(this).parent().parent().remove();
            $(this).parent().remove();
          });

          $(document).on('click', '.svz-remove-container', function(){
            delete properties[$(this).parent().parent().find('.svz-label-container').html()];
            allKeys.splice(_.indexOf(allKeys, $(this).parent().parent().find('.svz-label-container').html()), 1);
            $(this).parent().parent().remove();
            $(this).parent().remove();
          });
          
          $(document).on('keyup', '.svz-key', $.debounce(TIMEOUT_DEBOUNCE, function() {
             var currentID = $(this).attr('id').replace( /^\D+/g, '');

             if (_.include(allKeys, $(this).val()) 
              && $(this).val() != $('#svz-label-item' + currentID).html() 
              && $(this).val() != $('#svz-label-container' + currentID).html()){
                $('#svz-schema-form-submit' + currentID).prop('disabled', true);
                $('#svz-key-warning' + currentID).show();
                $('#svz-key' + currentID).css('border-color', '#ff0000');
              } else{
                $('#svz-schema-form-submit' + currentID).prop('disabled', false);
                $('#svz-key-warning' + currentID).hide();
                $('#svz-key' + currentID).css('border-color', '#cccccc');
              }
          }));

          window.AppendInputFieldToForm = function(currentIDnum, label, ID, name, currentClass){
            $('#svz-schema-form' + currentIDnum).append('<label class="additionaloption' + currentIDnum + '">' + label + '</label><div class="additionaloption' + currentIDnum + '" class="form-group"><input id="' + ID + currentIDnum + '" type="number" class="' + currentClass + '" name="' + name + currentIDnum + '" placeholder="' + label + '"></div>');
          }
          window.AppendCheckboxFieldToForm = function(currentIDnum, label, placeholder, IDdiv, IDinput, name){
            $('#svz-schema-form' + currentIDnum).append('<div hidden class="additionaloption' + currentIDnum + '" class="form-group"  id="' + IDdiv + currentIDnum + '"><label style="display: flex;"><input id="'+ IDinput + currentIDnum + '" name="' + name + currentIDnum + '" type="checkbox" placeholder="' + placeholder + '">' + label + '</label></div>');
          }
          window.AppendCheckboxFieldArray = function(currentIDnum){
            $('#svz-schema-form' + currentIDnum).append('<div class="additionaloption' + currentIDnum + '"><label style="display: flex;"><input id="svz-unique-items' + currentIDnum + '" name="uniqueItems' + currentIDnum + '" type="checkbox">Unique items (check for true)</label></div>');
          }
          window.AppendSubmitBtnToForm = function(currentIDnum){
            $('#svz-schema-form' + currentIDnum).append('<input class="btn btn-primary" id="svz-schema-form-submit' + currentIDnum + '" type="submit" value="Update">');
          }
          window.AppendReadonlyFieldToForm = function(currentIDnum){
            $('#svz-schema-form' + currentIDnum).append('<div class="additionaloption' + currentIDnum + '"><label style="display: flex;"><input id="svz-readonly' + currentIDnum + '" name="readonly' + currentIDnum + '" type="checkbox">Readonly (check for true)</label></div>');
          }

          window.RemoveFormShowEnum = function(currentIDnum){
            $('#svz-schema-form-submit' + currentIDnum).remove();
            $('#svz-enum' + currentIDnum).show();
            $('#svz-enum').prop('disabled', false);
            $('#svz-label-for-enum' + currentIDnum).show();
          }

          window.RemoveEnumRemoveTagit = function(currentIDnum){
            $('#svz-enum' + currentIDnum).hide();
            $('.tagit-choice').remove();
            $('#svz-label-for-enum' + currentIDnum).hide();
            $('#svz-schema-form-submit' + currentIDnum).remove();
          }

          $(document).on('change', '.svz-selected-type', $.debounce(TIMEOUT_DEBOUNCE, function() {
              var selectedType = $(this).val();
              var currentTabNum = $(this).attr('name').replace( /^\D+/g, '');
              $('.additionaloption' + currentTabNum).remove();

              if (selectedType){
                if ((_.include(selectedType, 'number') || _.include(selectedType, 'integer')) 
                  && _.include(selectedType, 'string')) {
                  RemoveFormShowEnum(currentTabNum);

                  AppendInputFieldToForm(currentTabNum, 'Maximum length', 'svz-max-length', 'maxLength', '');
                  AppendInputFieldToForm(currentTabNum, 'Minimum length', 'svz-min-length', 'minLength', '');
                  AppendInputFieldToForm(currentTabNum, 'Minimum', 'minimum', 'minimum', 'minimum');
                  AppendCheckboxFieldToForm(currentTabNum, 'Check - num will be more than minimum', 'Exclusive minimum', 'exclusive-min-div', 'exclusiveMinimum', 'exclusiveMinimum');
                  AppendInputFieldToForm(currentTabNum, 'Maximum', 'maximum', 'maximum', 'maximum');
                  AppendCheckboxFieldToForm(currentTabNum, 'Check - num will be more than maximum', 'Exclusive maximum', 'exclusive-max-div', 'exclusiveMaximum', 'exclusiveMaximum');
                  AppendInputFieldToForm(currentTabNum, 'Default', 'svz-default', 'default', '');
                  AppendCheckboxFieldToForm(currentTabNum, 'Readonly (check for true)', '', 'svz-readonly', 'readonly', '');
                  AppendReadonlyFieldToForm(currentTabNum);
                  AppendInputFieldToForm(currentTabNum, 'Pattern (regex)', 'svz-pattern', 'pattern', '');
                  AppendSubmitBtnToForm(currentTabNum);

                } else if (_.include(selectedType, 'string')){
                  RemoveFormShowEnum(currentTabNum);

                  AppendInputFieldToForm(currentTabNum, 'Maximum length', 'svz-max-length', 'maxLength', '');
                  AppendInputFieldToForm(currentTabNum, 'Minimum length', 'svz-min-length', 'minLength', '');
                  AppendInputFieldToForm(currentTabNum, 'Default', 'svz-default', 'default', '');
                  AppendReadonlyFieldToForm(currentTabNum);
                  AppendInputFieldToForm(currentTabNum, 'Pattern (regex)', 'svz-pattern', 'pattern', '');
                  AppendSubmitBtnToForm(currentTabNum);

                } else if (_.include(selectedType, 'number') || _.include(selectedType, 'integer')){
                  RemoveFormShowEnum(currentTabNum);

                  AppendInputFieldToForm(currentTabNum, 'Minimum', 'minimum', 'minimum', 'minimum');
                  AppendCheckboxFieldToForm(currentTabNum, 'Check - num will be more than minimum', 'Exclusive minimum', 'exclusive-min-div', 'exclusiveMinimum', 'exclusiveMinimum');
                  AppendInputFieldToForm(currentTabNum, 'Maximum', 'maximum', 'maximum', 'maximum');
                  AppendCheckboxFieldToForm(currentTabNum, 'Check - num will be more than maximum', 'Exclusive maximum', 'exclusive-max-div', 'exclusiveMaximum', 'exclusiveMaximum');
                  AppendInputFieldToForm(currentTabNum, 'Default', 'svz-default', 'default', '');
                  AppendReadonlyFieldToForm(currentTabNum);
                  AppendSubmitBtnToForm(currentTabNum);

                } else if (_.include(selectedType, 'array')){
                  RemoveEnumRemoveTagit(currentTabNum);

                  AppendInputFieldToForm(currentTabNum, 'Minimum items', 'svz-min-items', 'minItems', '');
                  AppendInputFieldToForm(currentTabNum, 'Maximum items', 'svz-max-items', 'maxItems', '');
                  AppendCheckboxFieldArray(currentTabNum);
                  AppendSubmitBtnToForm(currentTabNum);
                }
              }
          }));
        
          $(document).on('change', '.minimum', function(){
            var currentID = $(this).attr('id').replace( /^\D+/g, '');
            $('#exclusive-min-div' + currentID).toggle(!!$(this).val());
          }); 
          $(document).on('change', '.maximum', function(){
            var currentID = $(this).attr('id').replace( /^\D+/g, '');
            $('#exclusive-max-div' + currentID).toggle(!!$(this).val());
          }); 

          var required = [];
          var properties = {};

          window.ShowJSONPreview = function(){
            var jsonPreview = {
                  'schema': {
                    'type': 'object',
                    'properties': properties
                  }
            };
            if (required != ''){
              jsonPreview['required'] = required;
            } else{
              delete jsonPreview['required'];
            }

            $('#svz-json-text-header').hide();
            $('#svz-json-text').html(JSON.stringify(jsonPreview, undefined, 2));
          }


          Object.byString = function(o, s) {
            s = s.replace(/\[(\w+)\]/g, '.$1'); // convert indexes to properties
            s = s.replace(/^\./, '');           // strip a leading dot
            var a = s.split('.');
            for (var i = 0, n = a.length; i < n; ++i) {
                var k = a[i];
                if (k in o) {
                    o = o[k];
                } else {
                    return;
                }
            }
            return o;
          }

          window.search = function(path, obj, target) {
            for (var k in obj) {
              if (obj.hasOwnProperty(k)){
                if (obj[k] === target){
                  return path + "['" + k + "']";
                }
                else if (typeof obj[k] === "object") {
                    var result = search(path + "['" + k + "']", obj[k], target);
                    if (result){
                      return result;
                    }
                }
              }
                
            }
            return false;
          }

          window.HandleFormSubmit = function(currentObject, currentID){
            var currentID = currentID.replace( /^\D+/g, '');
            if($('#svz-key-warning').is(':visible')){
              return false;
            }

            if (_.include(allKeys, $('#svz-key' + currentID).val()) 
                && $('#svz-key' + currentID).val() != $('#svz-label-item' + currentID).html() 
                  && $('#svz-key' + currentID).val() != $('#svz-label-container' + currentID).html()){
              $('#svz-key-warning' + currentID).show();
              $('#svz-key' + currentID).css('border-color', '#ff0000');
              return false;
            } else{
              $('#svz-key-warning' + currentID).hide();
              $('#svz-key' + currentID).css('border-color', '#cccccc');
            }
            var currentKey = $('#svz-label-item' + currentID).html();
            if (!currentKey){
              currentKey = $('#svz-label-container' + currentID).html();
            }

            if (allKeys 
              && (currentKey != $('#svz-key' + currentID).val()) 
              && _.include(allKeys, currentKey)){ 

              var path = search('schema', properties, lastProperties);
              var words = [];
              path.replace(/\['(.+?)'\]/g, function($0, $1) { words.push($1) })
              var pathToValue = '';

              for (var i = 0; i < words.length; i++){
                if (i !== words.length - 1){
                  pathToValue += words[i] + '.';
                }
                else {
                  pathToValue += words[i];
                }
              } 

              try{
                var thisProperties = Object.byString(properties, pathToValue);
                var helper = thisProperties['type'];
              } catch(e){
                var thisProperties = properties;
              }
              
              var typesFromSelect = $('#svz-selected-type' + currentID).val();
              var typesFromSelectArray = $.map(typesFromSelect, function(value, index) {
                  return [value];
              });


              var schemaFormDataArray = $('#svz-schema-form' + currentID).serializeArray();
              var toDeleteRequired = true;

              if (typesFromSelectArray.length === 1){
                thisProperties['type'] = typesFromSelectArray[0];
              } else{
                thisProperties['type'] = typesFromSelectArray;
              }
              
              var chosenKey = $('#svz-key' + currentID).val();
              schemaFormDataArray = schemaFormDataArray.filter(function(n){return n.value !== ''});

              jQuery.each( schemaFormDataArray, function( i, field ) {
                if (field.value === 'on'){
                  field.value = 'true';
                }else if(field.name === 'key' + currentID){
                  chosenKey = field.value;
                  allKeys.push(chosenKey);
                } else if(field.name === 'required' + currentID){
                  toDeleteRequired = false;
                  if (field.value && !(_.include(required, chosenKey))) {
                      if (_.include(required, $('#svz-label-item' + currentID).html())){
                        required.splice(_.indexOf(required, $('#svz-label-item' + currentID).html()), 1);
                      }
                      required.push(chosenKey);
                  } 
                } else{
                  if (field.name.replace(/[0-9]/g, '') != 'tags' 
                      && field.name.replace(/[0-9]/g, '') != 'type'
                        && field.name.replace(/[0-9]/g, '') != 'key'){
                    thisProperties[field.name.replace(/[0-9]/g, '')] = field.value;
                  }
                }
              });

              $('#svz-label-item' + currentID).html(chosenKey);
              $('#svz-label-container' + currentID).html(chosenKey);

              var assignedEnum = $('#svz-enum' + currentID).tagit('assignedTags');
              if (assignedEnum != '') {
                thisProperties['enum'] = assignedEnum;
              }
              
              if (toDeleteRequired){
                required.splice(_.indexOf(required, chosenKey), 1);
              }

              pathToValue = pathToValue.split('.').slice(0,-1).join('.');
              
              try{
                Object.defineProperty(Object.byString(properties, pathToValue), $('#svz-key' + currentID).val(), Object.getOwnPropertyDescriptor(Object.byString(properties, pathToValue), currentKey));
                delete Object.byString(properties, pathToValue)[currentKey];
              } catch(e){
                Object.defineProperty(properties, $('#svz-key' + currentID).val(), Object.getOwnPropertyDescriptor(properties, currentKey));
                delete properties[currentKey];
              }
              
              
              allKeys.splice(_.indexOf(allKeys, currentKey), 1);

              return;
            }









            var typesFromSelect = $('#svz-selected-type' + currentID).val();
            var typesFromSelectArray = $.map(typesFromSelect, function(value, index) {
                return [value];
            });
            
            var chosenKey = '';

            if (typesFromSelectArray){
              $('#svz-for-form-form' + currentID).empty();

              var schemaFormDataArray = $('#svz-schema-form' + currentID).serializeArray();
              var currentProperties = {};
              var toDeleteRequired = true;

              if (typesFromSelectArray.length === 1){
                currentProperties['type'] = typesFromSelectArray[0];
              } else{
                currentProperties['type'] = typesFromSelectArray;
              }
              

              schemaFormDataArray = schemaFormDataArray.filter(function(n){return n.value !== ''});

              jQuery.each( schemaFormDataArray, function( i, field ) {
                if (field.value === 'on'){
                  field.value = 'true';
                }
                if(field.name === 'key' + currentID){
                  chosenKey = field.value;
                  allKeys.push(chosenKey);
                } else if(field.name === 'required' + currentID){
                  toDeleteRequired = false;
                  if (field.value && !(_.include(required, chosenKey))) {
                      if (_.include(required, $('#svz-label-item' + currentID).html())){
                        required.splice(_.indexOf(required, $('#svz-label-item' + currentID).html()), 1);
                      }
                      required.push(chosenKey);
                  } 
                } else{
                  if (field.name.replace(/[0-9]/g, '') != 'tags' && field.name.replace(/[0-9]/g, '') != 'type'){
                    currentProperties[field.name.replace(/[0-9]/g, '')] = field.value;
                  }
                }
              });

              $('#svz-label-item' + currentID).html(chosenKey);
              $('#svz-label-container' + currentID).html(chosenKey);

              var assignedEnum = $('#svz-enum' + currentID).tagit('assignedTags');
              if (assignedEnum != '') {
                currentProperties['enum'] = assignedEnum;
              }
              
              if (toDeleteRequired){
                required.splice(_.indexOf(required, chosenKey), 1);
              }

              if (!$(currentObject).parents(':eq(11)').html()){
                properties[chosenKey] = currentProperties;
              } else{
                var path = search('schema', properties, lastProperties);
                var words = [];
                try{
                  path.replace(/\['(.+?)'\]/g, function($0, $1) { words.push($1) })
                } catch(e){
                  return;
                }
                
                var pathToValue = '';

                for (var i = 0; i < words.length; i++){
                  //properties = properties[words[i]];
                  if (i !== words.length - 1){
                    pathToValue += words[i] + '.';
                  } else {
                    pathToValue += words[i];
                  }
                } 

                if (lastProperties['type'] !== 'object' && lastProperties['type'] !== 'array'){
                  var splittedPathToValueLength = pathToValue.split('.');
                  pathToValue = '';
                  for (var i = 0; i < splittedPathToValueLength.length - 2; i++){
                    if (i !== splittedPathToValueLength.length - 3){
                      pathToValue += splittedPathToValueLength[i] + '.';
                    } else{
                      pathToValue += splittedPathToValueLength[i];
                    }
                  }
                  try{
                    Object.byString(properties, pathToValue)['properties'][chosenKey] = currentProperties;
                  } catch(e) {
                    Object.byString(properties, pathToValue)['items'][chosenKey] = currentProperties;
                  }
                }else if (lastProperties['type'] === 'object'){
                  try{
                    Object.byString(properties, pathToValue)['properties'][chosenKey] = currentProperties;
                  } catch(e){
                    Object.byString(properties, pathToValue)['properties'] = {};
                    Object.byString(properties, pathToValue)['properties'][chosenKey] = currentProperties;
                  }
                } else if (lastProperties['type'] === 'array'){
                  try{
                    Object.byString(properties, pathToValue)['items'][chosenKey] = currentProperties;
                  } catch(e){
                    Object.byString(properties, pathToValue)['items'] = {};
                    Object.byString(properties, pathToValue)['items'][chosenKey] = currentProperties;
                  }
                }
                
                
                
              }
              lastProperties = currentProperties;

              try {
                  var sortableItemsArray = $('.container').sortable('toArray');
                  var sortableItemsArrayLength = sortableItemsArray.length;
                  for (var i = 0; i < sortableItemsArrayLength; i++) {
                      if (_.include(allKeys, $('#' + sortableItemsArray[i]).find('.svz-label-item').html())){
                        properties[$('#' + sortableItemsArray[i]).find('.svz-label-item').html()]['ordering'] = i + 1;
                      }
                  }
              } catch(err) {
                  //console.log('Error: ' + err.message);
              }

              if(_.include(typesFromSelectArray, 'object') || _.include(typesFromSelectArray, 'array')){
                AppendObjectArrayForm(currentID);
              } 


              $('#svz-for-form-form').jsonForm({
                schema: {
                  title: {
                    type: 'string',
                    title: 'Title'
                  },
                  description: {
                    type: 'string',
                    title: 'Description'
                  },
                  type: {
                    type: 'string',
                    title: 'Type'
                  }
                },
                onSubmit: function (errors, values) {
                  if (errors) {
                    //console.log(errors);
                    $('#res').html('<p>Fix your mistakes!</p>');
                  } else {
                    console.log('print form, will do it later!');
                  }
                }
              }); 

            } else{
                //console.log('fail happened!');
            }
          } 
        });
      })(jQuery);
   
    </script>
  </body>
</html>